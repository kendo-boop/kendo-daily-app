<% content_for :head do %>
  <%= stylesheet_link_tag "todos", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "todos", "data-turbo-track": "reload", defer: true %>
<% end %>

<div class="row">
  <div class="col s12">
    <div class="card">
      <div class="card-content">
        <span class="card-title">TODOリスト</span>
        
        <!-- TODOを追加リンク -->
        <div class="add-todo-link-wrapper">
          <a href="#modal-add-todo" class="modal-trigger add-todo-link">
            <i class="material-icons">add</i>TODOを追加
          </a>
        </div>
        
        <!-- TODOリスト表示 -->
        <% if @todos.any? %>
          <ul class="collection todos-collection">
            <% @todos.each do |todo| %>
              <li class="collection-item">
                <div class="todo-item-container">
                  
                  <div class="todo-content-wrapper">
                    <!-- チェックボックス -->
                    <%= form_with model: todo, url: todo_path(todo), method: :patch, local: true, class: "todo-checkbox-form" do |f| %>
                      <%= f.hidden_field :completed, value: !todo.completed %>
                      <%= f.check_box :completed_display, 
                                      checked: todo.completed,
                                      onchange: "this.form.submit();",
                                      class: "todo-checkbox" %>
                    <% end %>
                    
                    <!-- TODO内容 -->
                    <div class="todo-content">
                      <div class="todo-title <%= 'completed' if todo.completed %>">
                        <%= todo.title %>
                      </div>
                      
                      <div class="todo-meta">
                        <% if todo.category.present? %>
                          <span class="chip todo-category-chip">
                            <%= todo.category %>
                          </span>
                        <% end %>
                        
                        <% if todo.due_date.present? %>
                          <span>
                            <i class="material-icons tiny todo-due-date-icon">event</i>
                            <%= todo.due_date.strftime("%Y/%m/%d") %>
                            <% if todo.due_date < Date.today && !todo.completed %>
                              <span class="todo-overdue">期限切れ</span>
                            <% end %>
                          </span>
                        <% end %>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 削除ボタン -->
                  <a href="#!" 
                    class="delete-todo-btn todo-delete-btn" 
                    data-todo-id="<%= todo.id %>"
                    data-todo-title="<%= todo.title %>">
                    <i class="material-icons todo-delete-icon">delete</i>
                  </a>
                  
                  <!-- 削除用の隠しフォーム -->
                  <%= form_with model: todo, 
                                url: todo_path(todo), 
                                method: :delete, 
                                id: "delete-form-#{todo.id}",
                                class: "todo-delete-form",
                                data: { turbo: false } do |f| %>
                  <% end %>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="todos-empty-message">
            TODOがありません
          </p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- 追加モーダル -->
<div id="modal-add-todo" class="modal modal-add-todo">
  <div class="modal-content">
    <h4 class="modal-add-title">TODOを追加</h4>
    
    <%= form_with model: @todo, url: todos_path, data: { turbo: false } do |form| %>
      <div class="input-field">
        <%= form.text_field :title, id: "todo_title", placeholder: "例: 面打ちの練習 (50本)", required: true %>
        <%= form.label :title, "TODO" %>
      </div>
      
      <div class="row modal-form-row">
        <div class="col s12 m6">
          <label class="modal-field-label">カテゴリ</label>
          <%= form.select :category, 
                          options_for_select(Todo::CATEGORIES),
                          { include_blank: "選択してください" },
                          { class: "browser-default modal-select-field" } %>
        </div>
        
        <div class="col s12 m6">
          <label class="modal-field-label">期限</label>
          <input  type="date" 
                  name="todo[due_date]" 
                  id="todo_due_date"
                  class="browser-default modal-date-field"> 
        </div>
      </div>
      
      <div class="modal-submit-wrapper">
        <%= form.submit "追加", class: "btn modal-submit-btn" %>
      </div>
    <% end %>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect btn-flat modal-cancel-link">キャンセル</a>
  </div>
</div>

<!-- 削除確認モーダル -->
<div id="modal-delete-confirm" class="modal">
  <div class="modal-content modal-delete-content">
    <div class="delete-confirm-icon-wrapper">
      <div class="delete-confirm-icon-circle">
        <i class="material-icons delete-confirm-icon">delete_outline</i>
      </div>
    </div>
    <h4 class="delete-confirm-title">
      TODOを削除しますか?
    </h4>
    <p class="delete-confirm-message">
      「<span id="delete-todo-title" class="delete-confirm-todo-name"></span>」を削除します。<br>
      <span class="delete-confirm-warning">この操作は取り消せません。</span>
    </p>
  </div>
  <div class="modal-footer delete-modal-footer">
    <a href="#!" class="modal-close waves-effect btn-flat delete-cancel-btn">
      キャンセル
    </a>
    <a href="#!" id="confirm-delete-btn" class="waves-effect btn delete-confirm-btn">
      <i class="material-icons left delete-confirm-btn-icon">delete</i>削除する
    </a>
  </div>
</div>