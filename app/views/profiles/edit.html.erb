<% content_for :head do %>
  <%= stylesheet_link_tag "profile", "data-turbo-track": "reload" %>
<% end %>

<div class="row">
  <div class="col s12 m8 offset-m2">
    <div class="card">
      <div class="card-content">
        <span class="card-title">プロフィール編集</span>
        
        <%= form_with model: @profile, url: profile_path, local: true, html: { multipart: true } do |form| %>
          
          <!-- アバター画像 -->
          <div style="text-align: center; margin: 30px 0;">
            <label for="profile_avatar" style="cursor: pointer;">
              <% if @profile.avatar&.attached? %>
                <%= image_tag @profile.avatar.variant(resize_to_limit: [120, 120]),
                              style: "width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #33b5e5;",
                              alt: @profile.name,
                              id: "avatar-preview" %>
              <% else %>
                <div id="avatar-preview" style="width: 120px; height: 120px; border-radius: 50%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 3px solid #e0e0e0;">
                  <i class="material-icons" style="font-size: 48px; color: #9e9e9e;">add_a_photo</i>
                </div>
              <% end %>
              <div style="margin-top: 10px; color: #9e9e9e; font-size: 12px;">
                クリックして画像を変更
              </div>
            </label>
            <%= form.file_field :avatar, id: "profile_avatar", style: "display: none;", accept: "image/*" %>
          </div>

          <!-- 名前 -->
          <div class="input-field">
            <%= form.text_field :name, id: "profile_name", class: "validate", value: @profile.name %>
            <%= form.label :name, "名前", for: "profile_name" %>
          </div>

          <!-- メールアドレス（読み取り専用） -->
          <div style="display: flex; justify-content: space-between; padding: 20px 0; border-bottom: 1px solid #eeeeee;">
            <span style="color: #9e9e9e; font-weight: 400; font-size: 14px;">メールアドレス</span>
            <span style="color: #424242; font-weight: 400;"><%= current_user.email %></span>
          </div>

          <!-- 段位・自己紹介 -->
          <div class="input-field" style="margin: 30px 0 0;">
            <%= form.text_field :bio, id: "profile_bio", class: "validate", placeholder: "例: 三段もってます！", value: @profile.bio %>
            <%= form.label :bio, "段位・自己紹介", for: "profile_bio" %>
          </div>

          <!-- 登録日（読み取り専用） -->
          <div style="display: flex; justify-content: space-between; padding: 20px 0;">
            <span style="color: #9e9e9e; font-weight: 400; font-size: 14px;">登録日</span>
            <span style="color: #424242; font-weight: 400;"><%= current_user.created_at.strftime("%Y年%m月%d日") %></span>
          </div>

          <!-- 送信ボタン -->
          <div style="margin-top: 20px;">
            <%= form.submit "更新する", class: "btn", style: "background: #33b5e5; width: 100%; height: 42px; line-height: 42px; padding: 0;" %>
          </div>

        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    M.updateTextFields();
  });
  
  document.getElementById('profile_avatar').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('avatar-preview');
        if (preview.tagName === 'IMG') {
          preview.src = e.target.result;
        } else {
          preview.outerHTML = '<img id="avatar-preview" src="' + e.target.result + '" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #33b5e5;">';
        }
      }
      reader.readAsDataURL(file);
    }
  });
</script>