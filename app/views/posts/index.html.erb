<% content_for :head do %>
  <%= stylesheet_link_tag "posts", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "post", "data-turbo-track": "reload", defer: true %>
<% end %>

<div class="row">
  <div class="col s12 m10 offset-m1 l8 offset-l2">
    
    <!-- タブ切り替え（みんなの投稿 / 自分の投稿） -->
    <div class="card tab-card">
      <div class="card-content tab-content">
        <div class="tab-buttons">
          <%= link_to posts_path, class: "btn tab-btn #{current_page?(posts_path) ? 'active' : 'inactive'}" do %>
            <i class="material-icons left">forum</i>みんなの投稿
          <% end %>
          <%= link_to my_posts_posts_path, class: "btn tab-btn #{current_page?(my_posts_posts_path) ? 'active' : 'inactive'}" do %>
            <i class="material-icons left">person</i>自分の投稿
          <% end %>
        </div>
      </div>
    </div>
    
    <!-- 投稿フォームカード（みんなの投稿ページでのみ表示） -->
    <% unless current_page?(my_posts_posts_path) %>
      <div class="card post-form-card">
        <div class="post-form-content">
          <%= form_with model: @post, url: posts_path, local: true, html: { multipart: true } do |form| %>
            <%= form.text_area :content, 
                              placeholder: "稽古の様子や、質問など、自由に投稿してください", 
                              class: "post-textarea",
                              rows: "4" %>
            
            <div id="media-preview"></div>
            
            <div class="post-form-footer">
              <label class="post-media-btn">
                <i class="material-icons">photo_camera</i>
                <span>画像・動画を追加</span>
                <%= form.file_field :media_file, 
                    accept: "image/*,video/*",
                    class: "post-file-input",
                    id: "post_media_file" %> 
              </label>
              
              <%= form.submit "投稿する", class: "post-submit-btn" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    
    <!-- 投稿一覧 -->
    <% if @posts.any? %>
      <% @posts.each do |post| %>
        <div class="card post-card">
          <div class="card-content">
            
            <!-- 投稿ヘッダー -->
            <div class="post-header">
              <div class="post-user-info">
                <div class="post-user-badge">
                  <i class="material-icons">person</i>
                  <span title="<%= post.user.profile.name %>"><%= post.user.profile.name.truncate(15) %></span>
                </div>
                <div class="post-meta">
                  <span class="post-timestamp">
                    <i class="material-icons">schedule</i>
                    <%= time_ago_in_words(post.created_at) %>前
                  </span>
                </div>
              </div>
              
              <% if post.user == current_user %>
                <div class="post-actions-menu">
                  <a  href="javascript:void(0);" 
                      class="post-menu-btn" 
                      onclick="togglePostMenu(<%= post.id %>); return false;">
                    <i class="material-icons">more_vert</i>
                  </a>
                  
                  <div id="post-menu-<%= post.id %>" class="post-menu-dropdown">
                    <a  href="#!" 
                        class="post-delete-link delete-post-btn" 
                        data-post-id="<%= post.id %>"
                        data-post-content="<%= post.content.truncate(30) %>">
                      <i class="material-icons">delete</i>削除
                    </a>
                  </div>
                  
                  <%= form_with model: post, 
                                url: post_path(post), 
                                method: :delete, 
                                id: "delete-post-form-#{post.id}",
                                class: "post-delete-form" do |f| %>
                  <% end %>
                </div>
              <% end %>
            </div>
            
            <!-- 投稿内容 -->
            <div class="post-content-text">
              <%= simple_format(h(post.content), {}, sanitize: false) %>
            </div>
      
            <!-- メディア（画像・動画） -->
            <% if post.media_file.attached? %> 
              <div class="post-media-container">
                <div class="post-media-item">
                  <% if post.media_file.content_type.start_with?('image/') %> 
                    <%= image_tag url_for(post.media_file), class: "post-media-image", alt: "投稿画像" %> 
                  <% elsif post.media_file.content_type.start_with?('video/') %> 
                    <%= video_tag url_for(post.media_file), controls: true, class: "post-media-video" %> 
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- いいね・コメントボタン -->
            <div class="post-footer">
              <div class="post-stats">
                <div class="post-stat-item post-stat-likes">
                  <i class="material-icons">favorite</i>
                  <span><%= post.likes_count %></span>
                </div>
                <div class="post-stat-item post-stat-comments">
                  <i class="material-icons">comment</i>
                  <span><%= post.comments_count %>コメント</span>
                </div>
              </div>
              
              <div class="post-action-buttons">
                <% if post.liked_by?(current_user) %>
                  <%= link_to unlike_post_path(post), 
                              data: { turbo_method: :delete },
                              remote: true,
                              class: "post-action-btn liked",
                              id: "like-btn-#{post.id}" do %>
                    <i class="material-icons">favorite</i>
                    <span>いいね</span>
                  <% end %>
                <% else %>
                  <%= link_to like_post_path(post), 
                              data: { turbo_method: :post },
                              remote: true,
                              class: "post-action-btn",
                              id: "like-btn-#{post.id}" do %>
                    <i class="material-icons">favorite_border</i>
                    <span>いいね</span>
                  <% end %>
                <% end %>
                
                <a  href="javascript:void(0);" 
                    class="post-action-btn" 
                    onclick="toggleComments(<%= post.id %>); return false;">
                  <i class="material-icons">comment</i>
                  <span>コメント</span>
                </a>
              </div>
              
              <!-- コメントセクション -->
              <div class="comments-section" id="comments-section-<%= post.id %>">
                <div class="comments-header">
                  <i class="material-icons">chat_bubble</i>
                  <span>コメント</span>
                </div>
                
                <div id="comments-list-<%= post.id %>">
                  <% comments = post.recent_comments(10) %>
                  <% if comments.any? %>
                    <% comments.each do |comment| %>
                      <div class="comment-item" id="comment-<%= comment.id %>">
                        <div class="comment-header">
                          <span class="comment-user"><%= comment.user.profile.name %></span>
                          <div class="comment-actions">
                            <span class="comment-time"><%= time_ago_in_words(comment.created_at) %>前</span>
                            <% if comment.user == current_user %>
                              <%= link_to post_comment_path(post, comment), 
                                          data: { turbo_method: :delete, turbo_confirm: 'コメントを削除しますか?' },
                                          remote: true,
                                          class: "comment-delete-btn" do %>
                                <i class="material-icons">delete</i>
                              <% end %>
                            <% end %>
                          </div>
                        </div>
                        <div class="comment-text">
                          <%= simple_format(h(comment.content), {}, sanitize: false) %>
                        </div>
                      </div>
                    <% end %>
                    
                    <% if post.comments_count > 10 %>
                      <p class="comments-more-info">
                        <i class="material-icons tiny">info</i>
                        最新10件のコメントを表示しています（全<%= post.comments_count %>件）
                      </p>
                    <% end %>
                  <% else %>
                    <div class="comments-empty">
                      まだコメントがありません。最初のコメントを投稿しましょう！
                    </div>
                  <% end %>
                </div>
                
                <!-- コメント入力フォーム -->
                <%= form_with model: [post, Comment.new], 
                              url: post_comments_path(post),
                              local: false,
                              html: { class: "comment-form", id: "comment-form-#{post.id}" } do |f| %>
                  <%= f.text_area :content, 
                                  placeholder: "コメントを入力...", 
                                  class: "comment-input",
                                  rows: "2" %>
                  <%= f.submit "送信", class: "comment-submit-btn" %>
                <% end %>
              </div>
            </div>
            
          </div>
        </div>
      <% end %>
      
      <!-- ページネーション -->
      <div class="pagination-wrapper">
          <%= paginate @posts, 
            window: 1,
            outer_window: 0,
            previous_label: '‹',
            next_label: '›',
            first_label: '«',
            last_label: '»' %>
      </div>
      
    <% else %>
      <div class="card empty-state-card">
        <div class="card-content center-align">
          <i class="material-icons large empty-icon">forum</i>
          <p class="empty-message">
            <% if current_page?(my_posts_posts_path) %>
              まだ投稿がありません
            <% else %>
              まだ投稿がありません
            <% end %>
          </p>
          <p class="empty-sub-message">最初の投稿をしてみましょう!</p>
        </div>
      </div>
    <% end %>
    
    <!-- 投稿削除確認モーダル -->
    <div id="modal-delete-post-confirm" class="modal">
      <div class="modal-content delete-modal-content">
        <div class="delete-confirm-icon-wrapper">
          <div class="delete-confirm-icon-circle">
            <i class="material-icons delete-confirm-icon">delete_outline</i>
          </div>
        </div>
        <h4 class="delete-confirm-title">投稿を削除しますか?</h4>
        <p class="delete-confirm-message">
          「<span id="delete-post-content" class="delete-confirm-todo-name"></span>」を削除します。<br>
          <span class="delete-confirm-warning">この操作は取り消せません。</span>
        </p>
      </div>
      <div class="modal-footer delete-modal-footer">
        <a href="#!" class="modal-close waves-effect btn-flat delete-cancel-btn">
          キャンセル
        </a>
        <a href="#!" id="confirm-delete-post-btn" class="waves-effect btn delete-confirm-btn">
          <i class="material-icons left delete-confirm-btn-icon">delete</i>削除する
        </a>
      </div>
    </div>
    
  </div>
</div>